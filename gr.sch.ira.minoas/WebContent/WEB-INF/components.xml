<?xml version="1.0" encoding="UTF-8"?>
<components xmlns="http://jboss.com/products/seam/components"
  xmlns:core="http://jboss.com/products/seam/core" xmlns:ui="http://jboss.com/products/seam/ui"
  xmlns:persistence="http://jboss.com/products/seam/persistence" xmlns:drools="http://jboss.com/products/seam/drools"
  xmlns:bpm="http://jboss.com/products/seam/bpm" xmlns:security="http://jboss.com/products/seam/security"
  xmlns:mail="http://jboss.com/products/seam/mail" xmlns:web="http://jboss.com/products/seam/web"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:theme="http://jboss.com/products/seam/theme"
  xmlns:transaction="http://jboss.com/products/seam/transaction" xmlns:document="http://jboss.com/products/seam/document"
  xmlns:framework="http://jboss.com/products/seam/framework"
  xsi:schemaLocation="http://jboss.com/products/seam/core http://jboss.com/products/seam/core-2.1.xsd 
                 http://jboss.com/products/seam/persistence http://jboss.com/products/seam/persistence-2.1.xsd 
                 http://jboss.com/products/seam/drools http://jboss.com/products/seam/drools-2.1.xsd
                 http://jboss.com/products/seam/bpm http://jboss.com/products/seam/bpm-2.1.xsd
                 http://jboss.com/products/seam/security http://jboss.com/products/seam/security-2.1.xsd
                 http://jboss.com/products/seam/mail http://jboss.com/products/seam/mail-2.1.xsd
                 http://jboss.com/products/seam/components http://jboss.com/products/seam/components-2.1.xsd
                 http://jboss.com/products/seam/theme http://jboss.com/products/seam/theme-2.1.xsd
                 http://jboss.com/products/seam/web http://jboss.com/products/seam/web-2.1.xsd
                 http://jboss.com/products/seam/transaction http://jboss.com/products/seam/transaction-2.1.xsd
                 http://jboss.com/products/seam/document http://jboss.com/products/seam/document-2.1.xsd
                 http://jboss.com/products/seam/ui http://jboss.com/products/seam/ui-2.1.xsd 
                 http://jboss.com/products/seam/framework http://jboss.com/products/seam/framework-2.1.xsd">


  <core:init debug="true" jndi-pattern="@jndiPattern@"
    transaction-management-enabled="true" />


  <core:manager concurrent-request-timeout="500"
    conversation-timeout="120000" conversation-id-parameter="cid"
    parent-conversation-id-parameter="pid" />

  <persistence:managed-persistence-context
    name="entityManager" auto-create="true"
    persistence-unit-jndi-name="java:/EntityManagerFactories/minoasDatabase" />

  <ui:jpa-entity-loader entity-manager="#{entityManager}" />



  <transaction:ejb-transaction />

  <web:character-encoding-filter encoding="UTF-8"
    override-client="true" url-pattern="*.seam" />

  
  <document:document-store use-extensions="true" />

  <!--
    <drools:rule-base name="securityRules"> <drools:rule-files>
    <value>/security.drl</value> </drools:rule-files> </drools:rule-base>
  -->

  <security:rule-based-permission-resolver
    security-rules="#{securityRules}" />

  <security:identity authenticate-method="#{authenticator.authenticate}" />


  <event type="org.jboss.seam.security.notLoggedIn">
    <action execute="#{redirect.captureCurrentView}" />
    <action execute="#{identity.tryLogin}" />
  </event>
  <event type="org.jboss.seam.security.loginSuccessful">
    <action execute="#{redirect.returnToCapturedView}" />
  </event>

  <!-- 
  <event type="org.jboss.seam.afterTransactionSuccess.PreparatoryOwner">
    <action execute="#{preparatoryOwnersList.refresh}" />
    <action execute="#{preparatoryOwnersList.getResultList}" />
  </event>

   -->
  <component name="org.jboss.seam.persistence.persistenceProvider"
    class="org.jboss.seam.persistence.HibernatePersistenceProvider" />

  <mail:mail-session host="localhost" port="2525" username="test"
    password="test" />

  <factory name="preparatoryOwner" value="#{preparatoryOwnerHome.instance}" />
  
  <component name="examplePreparatoryOwner"
    class="gr.sch.ira.minoas.model.preparatory.PreparatoryOwner" scope="conversation" />
 
  <framework:entity-query name="preparatoryOwnersList"
    scope="conversation" max-results="15">
    <framework:ejbql>SELECT o FROM PreparatoryOwner o</framework:ejbql>
    <framework:restrictions>

      <value>lower(o.lastName) like lower(concat(#{examplePreparatoryOwner.lastName},'%') )</value>
        <value>lower(o.firstName) like lower(concat(#{examplePreparatoryOwner.firstName},'%') )</value>
        <value>lower(o.fatherName) like lower(concat(#{examplePreparatoryOwner.fatherName},'%') )</value>
        <value>lower(o.idNumber) like lower(concat(#{examplePreparatoryOwner.idNumber},'%') )</value>
      </framework:restrictions>
   </framework:entity-query>
  
   <component name="exampleEstablishmentLicense" class="gr.sch.ira.minoas.model.preparatory.EstablishmentLicense" scope="conversation">
    <property name="owner">#{examplePreparatoryOwner}</property>
   </component>
   
   <framework:entity-query 
      name="establishmentLicensesList" 
      scope="conversation" order="requestDate" max-results = "15">
      <framework:ejbql>SELECT o FROM EstablishmentLicense o</framework:ejbql>  
      <framework:restrictions>
        <value>lower(o.owner.lastName) like lower( concat(#{exampleEstablishmentLicense.owner.lastName},'%') )</value>
        <value>o.requestProtocol=#{exampleEstablishmentLicense.requestProtocol}</value>
        <value>o.natureType=#{exampleEstablishmentLicense.natureType}</value>
        <value>o.statusType=#{exampleEstablishmentLicense.statusType}</value>
    </framework:restrictions> 
   </framework:entity-query>     
   

   <!-- School Components -->   
   
  <component name="exampleSchool"
    class="gr.sch.ira.minoas.model.core.School" scope="conversation" />
 
  <framework:entity-query name="schoolList"
    scope="conversation" max-results="15">
    <framework:ejbql>SELECT o FROM School o</framework:ejbql>
    <framework:restrictions>

      <value>lower(o.title) like lower(concat('%', concat(#{exampleSchool.title},'%')))</value>
      <value>lower(o.regionCode) like lower(concat('%', concat(#{exampleSchool.regionCode},'%')))</value>
      <value>o.points = #{exampleSchool.points}</value>
     </framework:restrictions>
   </framework:entity-query>
   
   <!-- Teaching Requirement -->
   
   <component name="exampleTeachingRequirement" class="gr.sch.ira.minoas.model.core.TeachingRequirement" scope="conversation" />
   
         
   <!-- Employee Components -->
   
  <component name="exampleEmployee" class="gr.sch.ira.minoas.model.employee.Employee" />
   
   <framework:entity-query name="employeeListQuery" max-results="100">
    <framework:ejbql>SELECT e FROM Employee e</framework:ejbql>
    <framework:order>e.lastName asc, e.firstName asc</framework:order>
    <framework:restrictions>
      <value>lower(e.lastName) like lower(concat('%', concat(#{exampleEmployee.lastName},'%')))</value>
      <value>lower(e.firstName) like lower(concat('%', concat(#{exampleEmployee.firstName},'%')))</value>
      <value>e.lastSpecialization = #{exampleEmployee.lastSpecialization}</value>
      <value>e.active = #{employeeCriteria.onlyActive}</value>
    </framework:restrictions>
   </framework:entity-query>
   
   <!-- Employment Components -->
   
   
   <framework:entity-query name="regularEmploymentsListQuery" max-results="200">
    <framework:ejbql>SELECT e FROM Employment e WHERE e.type='REGULAR'</framework:ejbql>
    <framework:order>e.specialization.id asc, e.employee.lastName asc</framework:order>
    <framework:restrictions>
      <value>e.active = #{regularEmploymentCriteria.onlyActive}</value>
      <value>e.school = #{regularEmploymentCriteria.school}</value>
      <value>e.schoolYear.id = #{regularEmploymentCriteria.schoolYear.id}</value>
    </framework:restrictions> 
   </framework:entity-query>
   
   <framework:entity-query name="deputyEmploymentsListQuery" max-results="200">
    <framework:ejbql>SELECT e FROM Employment e WHERE e.type='DEPUTY'</framework:ejbql>
    <framework:order>e.specialization.id asc, e.employee.lastName asc</framework:order>
    <framework:restrictions>
      <value>e.active = #{deputyEmploymentCriteria.onlyActive}</value>
      <value>e.school = #{deputyEmploymentCriteria.school}</value>
      <value>e.schoolYear.id = #{deputyEmploymentCriteria.schoolYear.id}</value>
    </framework:restrictions> 
   </framework:entity-query>
   
   
   <!-- For use with jBPM pageflow or process management -->
   
   <bpm:jbpm >
   	   <bpm:pageflow-definitions>
           <!-- 
           <value>new-principal.jpdl.xml</value>
           <value>new-school-year.jpdl.xml</value>
           <value>edit-school-year.jpdl.xml</value>
           <value>school-search.jpdl.xml</value>
            -->
           <value>pageflows/new-secondment.jpdl.xml</value>
           <value>pageflows/school-record.jpdl.xml</value>
           <value>pageflows/employee-record.jpdl.xml</value>
           <value>pageflows/active-secondments.jpdl.xml</value>
           <value>pageflows/school-incoming-secondments.jpdl.xml</value>
       </bpm:pageflow-definitions>
   </bpm:jbpm>
   
 
   

</components>
